# Performance

- Chunk Renderer was rewritten to avoid the GL fixed-function pipeline. 
  - Expect dramatic boost to baking and rendering performance, especially for higher render distance.
  - *The Chunk Renderer will be fully migrated to programmable shaders in a future release.*
    
- Dramatically improved arrow entity performance (fewer drawcalls)

- Improved light update performance.

- All entities now benefit from light caching.
  - Caching was moved down from `Particle` to `Entity` since it's cheap and effective.

- Chunk saving is slightly faster by batching small writes (i.e. NBT primitives).

- Biome calculation is slightly faster, slightly improving chunk baking speed.
  - *Biome and temperature is always calculated on demand, be it from noise or texture.
    This is likely to become persistent data in the future.*

# Scripting API

<details>
<summary>
New <code>PlayerInventory</code> API
</summary>

```ts
// 2 new methods
class PlayerInventory {
    /** Returns the Armor slot of an item, based on ID. */
    function getArmorSlot(itemId: number): number;

    /** Returns the Armor slot of an item, based on ID and damage value. */
    function getArmorSlot(itemId: number, itemDamage: number): number;
}
```

</details>

<details>
<summary>
WIP <code>GameMode</code> API
</summary>

```ts
/** New class in preparation for multiplayer and per-player game modes, similar to modern MC. */
class GameMode {
    function getName(): "debug" | "adventure";
}

// 1 new method
class EntityPlayer {
    /** Returns the currently active game mode. */
    function getGameMode(): GameMode;
}
```

</details>

<details>
<summary>
Improved Custom Data & physics API on <code>Entity</code>
</summary>

```ts
/** Primitive types that persist on save.
  * Boolean is not supported yet (not explicitly representable in NBT). */
type Tag = null | number | string;

enum Facing {
	Down = 0,
	Up = 1,
	North = 2,
	South = 3,
	West = 4,
	East = 5,
}

// 1 new property, 4 new methods
class Entity {
    /** If entity has noclip active (no collision with blocks, triggers, etc.) */
    get noPhysics(): boolean;
    set noPhysics(value: boolean);
    
    /** Get if a value with the given key exists. */
    function hasTag(key: string): boolean;

    /** Get a tag by key. */
    function getTag(key: string): Tag;

    /** Set a tag by key. 
      * Returns the previous value.
      * Unsupported types will not persist on save. */
    function setTag(key: string, value: Tag): Tag;

    /** Returns the face direction of the yaw rotation based on the cardinal points. */
    function getFacing(): Facing;
}
```

</details>

<details>
<summary>
Deprecated color properties on <code>Model</code>, and new <code>ModelBlockbench</code> method
</summary>

```ts
// 1 new method
class ModelBlockbench {
    function addBoxInflated(width: number, height: number, length: number, textureOffsetX: number, textureOffsetY: number, inflate: number);
}
```

```ts
/** Options for {@link Model} color. */
enum ModelColorMode {
    Default = 0,
    AttachedTo = 1,
    Custom = 2,
    ModelAttachment = 3,
}

// (2 new) & (5 deprecated) properties, 2 deprecated methods
class Model {
    /** Options for model color. */
    colorMode: ModelColorMode;

    /** Color of model. Interacts with {@link colorMode}. */
    color: Vec4;
    
    /** @deprecated Alias of {@link colorMode}; renamed to {@link colorMode} */
    modes: ModelColorMode;

    /** @deprecated Alias of {@link color.r}; use {@link color.r} or {@link color.x} */
    colorRed: number;
    
    /** @deprecated Alias of {@link color.g}; use {@link color.g} or {@link color.y} */
    colorGreen: number;
    
    /** @deprecated Alias of {@link color.b}; use {@link color.b} or {@link color.z} */
    colorBlue: number;
    
    /** @deprecated Alias of {@link color.a}; use {@link color.a} or {@link color.w}. */
    colorAlpha: number;
    
    /** @deprecated Alias of {@link color}; set {@link color} instead. */
    function setRGB(r: number, g: number, b: number);

    /** @deprecated Alias of {@link color}; set {@link color} instead. */
    function setRGBA(r: number, g: number, b: number, a: number);
}
```

</details>

<details>
<summary>
Deprecated color members on <code>UIElement</code>
</summary>

```ts
// 1 new constructor
class UIElement {
    constructor(x: number, y: number);
}

// 1 new property, 4 deprecated properties
class UISprite {
    // Color of sprite.
    color: Vec4;

    /** @deprecated Alias of {@link color.r}; use {@link color.r} or {@link color.x}. */
    red: number;
    
    /** @deprecated Alias of {@link color.g}; use {@link color.g} or {@link color.y}. */
    green: number;
    
    /** @deprecated Alias of {@link color.b}; use {@link color.b} or {@link color.z}. */
    blue: number;
    
    /** @deprecated Alias of {@link color.a}; use {@link color.a} or {@link color.w}. */
    alpha: number;
}

// (1 new) & (4 deprecated) properties, (2 new) & (2 deprecated) constructors
class UIRect {
    // Color of rect.
    color: Vec4;

    /** @deprecated Alias of {@link color.r}; use {@link color.r} or {@link color.x}. */
    red: number;
    
    /** @deprecated Alias of {@link color.g}; use {@link color.g} or {@link color.y}. */
    green: number;
    
    /** @deprecated Alias of {@link color.b}; use {@link color.b} or {@link color.z}. */
    blue: number;
    
    /** @deprecated Alias of {@link color.a}; use {@link color.a} or {@link color.w}. */
    alpha: number;

    constructor(x: number, y: number, width: number, height: number, color: Vec4);

    constructor(x: number, y: number, width: number, height: number, color: Vec4, container?: UIContainer);

    /** @deprecated Alias of {@link UIRect:constructor(number, number, number, number, Vec4)}. */
    constructor(x: number, y: number, width: number, height: number, red: number, green: number, blue: number, alpha: number);

    /** @deprecated Alias of {@link UIRect:constructor(number, number, number, number, Vec4, UIContainer)}. */
    constructor(x: number, y: number, width: number, height: number, red: number, green: number, blue: number, alpha: number, container?: UIContainer);
}

// (1 new) & (4 deprecated) properties
class UILabel {
    // Color of label text.
    color: Vec4;

    /** @deprecated Alias of {@link color.r}; use {@link color.r} or {@link color.x}. */
    red: number;
    
    /** @deprecated Alias of {@link color.g}; use {@link color.g} or {@link color.y}. */
    green: number;
    
    /** @deprecated Alias of {@link color.b}; use {@link color.b} or {@link color.z}. */
    blue: number;
    
    /** @deprecated Alias of {@link color.a}; use {@link color.a} or {@link color.w}. */
    alpha: number;
}

```

</details>

<details>
<summary>
New <code>Vec4</code> type, and aliases in <code>Vec3</code> 
</summary>

```ts
// New 4D vector type, similar to the existing Vec3.
class Vec4 {
    x: number;
    y: number;
    z: number;
    w: number;

	constructor(x: number, y: number, z: number, w: number);
    
	constructor(xyz: Vec3, w: number);

    /** Component-wise add. */
	function add(other: Vec4): Vec4;

    /** Component-wise subtract. */
    function subtract(other: Vec4): Vec4;

    /** Component-wise multiply by scalar. */
	function scale(value: number): Vec4;
 
    /** Euclidean length. */
	function length(): number;

    /** Euclidean distance. */
	function distance(other: Vec4): number;

    /** Alias of {@link x}{@link y}{@link z}. */
    get xyz(): Vec3;
    set xyz(values: Vec3); 

    /** Alias of {@link x}. */ 
    get r(): number;
    set r(value: number);

    /** Alias of {@link y}. */
    get g(): number;
    set g(value: number);
    
    /** Alias of {@link z}. */
    get b(): number;
    set b(value: number);
    
    /** Alias of {@link w}. */
    get a(): number;
    set a(value: number);
}

// 3 new alias properties.
class Vec3 {
    /** Alias of {@link x}. */
    get r(): number;
    set r(value: number);

    /** Alias of {@link y}. */
    get g(): number;
    set g(value: number);
    
    /** Alias of {@link z}. */
    get b(): number;
    set b(value: number);
}
```

</details>


# Commands

<details>
<summary>
New <code>/gamerule</code> command - replaces previous toggles
</summary>

- Replacement for previous commands:
  
  |                  |                                      |                                          |
  | ---------------- | ------------------------------------ | ---------------------------------------- |
  | `/toggledecay`   | `/gamerule decay_leaves`             | Toggles leave decay                      |
  | `/togglemelting` | `/gamerule melt_ice`                 | Toggles ice melting                      |
  | `/mobsburn`      | `/gamerule sunburn_undead`           | Toggles mobs burning in daylight         |
  | `/config ...`    | `/gamerule allow_inventory_crafting` | Toggles if player can craft in inventory |

- New rules:

  |                            |                                                                                                                         |
  | -------------------------- | ----------------------------------------------------------------------------------------------------------------------- |
  | `allow_bed`                | Toggles if player can sleep in beds [#7](https://github.com/Adventurecraft-Awakening/AC-Legacy-Mod/issues/7)            |
  | `allow_hoe`                | Toggles hoe usage outside of debug mode [#11](https://github.com/Adventurecraft-Awakening/AC-Legacy-Mod/issues/11)      |
  | `allow_bonemeal`           | Toggles bonemeal usage outside of debug mode [#15](https://github.com/Adventurecraft-Awakening/AC-Legacy-Mod/issues/15) |
  | `freeze_water`             | Toggles if water freezes while it's snowing/temperature low                                                             |
  | `snow_accumulation_height` | Sets maximum snow accumulation height on ground while it's snowing                                                      |

</details>

- Updated `/scriptstats` screen
  - Game keeps running when screen is open
  - Columns can now be sorted


# Quality of Life

- Selected mainhand and offhand slots will persist on save [#60](https://github.com/Adventurecraft-Awakening/AC-Legacy-Mod/issues/60)

- Improved Timer block screen:
  - Sliders replaced with input fields.
  - Input fields starting with correct decimal separator.
  - Input fields show invalid values in red color.
  - *Other screens will be cleaned up in a future release.*

- Block picking in debug mode.
  - Middle mouse click on blocks puts the hit block into your current slot.
  - Picking tries to be clever and swaps slots in your inventory if you already have the item.

- Customizable spawner scripts are now selected with a friendly file picker.
  - *The file picker will be integrated into other screens in a future release.*

- F3 debug overlay has been cleaned up.
  - New information: commit/version metadata, chunk mesh memory usage.

- Improved input fields with cursor and selection.
  - Cursor/selection can be moved with arrow keys (Ctrl for jump, Shift for expanding/shrinking)
  - Pasting occurs at cursor, or replaces selection if there is one

- Tools now copy NBT data (trigger settings, effect block settings, flower sizes, tile entity contents, etc.)
  - This includes Copy, Paste and Nudge items.
  - Undo history already supported NBT.


# Bugfixes

- Cake, Repeater and Sugar cane can't be placed outside of debug mode anymore [#9](https://github.com/Adventurecraft-Awakening/AC-Legacy-Mod/issues/9)

- Cake can now be consumed as long as player `health < player.maxHealth` [#10](https://github.com/Adventurecraft-Awakening/AC-Legacy-Mod/issues/10)
  - Previously you could only eat cake if `health < 20` (less than 5 hearts)

- You can now place blocks at height y=127` [#43](https://github.com/Adventurecraft-Awakening/AC-Legacy-Mod/issues/43)

- Destroy speed while flying is now the same as while being on ground [#23](https://github.com/Adventurecraft-Awakening/AC-Legacy-Mod/issues/23)

- Double-click to open a save works again

- Heartpieces properly persist on save again

- Boomerang flies through clip blocks per default again (was accidentally reversed with last big update)

- JS errors in custom mob `OnAttacked` scripts don't crash the game anymore [#114](https://github.com/Adventurecraft-Awakening/AC-Legacy-Mod/issues/114)

- `UIElement`s won't persist on screen anymore when you exit through the death screen [#105](https://github.com/Adventurecraft-Awakening/AC-Legacy-Mod/issues/105)

- Entity scopes should flow properly between scripts now.
  - Calling `runScript()` inside `OnCreated`, `OnDeath`, etc. should behave as expected now.

- `OnCreated` is now delayed until first tick to prevent multiple invocations.
  - Calling `setOnCreated()` multiple times only results in one `OnCreated` invocation on the next tick.
  - `setEntityDescription()` still calls `OnCreated` instantly.

- Occlusion culling (Advanced OpenGL setting) has been improved.
  - Expect fewer missing chunks.
  - Extra effective on low-end GPU that struggle with vertex count. 

- Keyboard triggers now only work in intended modes (e.g. not during F7 item palette, not in ESC menu)

- "Shift + E" now only opens the item palette in debug mode (as it was initially intended)

